<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manga</title>
    <!--css -->
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/category.css">
    <link rel="stylesheet" href="../css/header_footer.css">
    <link rel="stylesheet" href="../css/category.css">
    <link rel="stylesheet" href="../css/cart_1.css">
    <link rel="stylesheet" href="../css/billing.css">
    <link rel="stylesheet" href="../css/order.css">
    <!-- <link rel="stylesheet" href="../css/login.css">
    <link rel="stylesheet" href="../css/signup.css"> -->
    <link rel="icon" type="image/png" href="../img/WEBTOON_Logo.png">
    <!-- fontawesome -->
    <script src="https://kit.fontawesome.com/758055a090.js" crossorigin="anonymous"></script>
</head>

<body>
    <!-- <special-header></special-header> -->
    <header>
        <nav class="navbar">
            <!-- logo -->
            <div class="navbar__logo">
                <a href="index.html"><img src="../img/WEBTOON_Logo.png" alt="website logo"></a>
            </div>
            <!-- links -->
            <ul class="navbar__links">
                <li class="navbar__link--home"><a href="index.html" class="navbar__link">Home</a></li>
                <li class="navbar__link--series">
                    <a href="#" class="navbar__link">Series</a>
                    <div class="navbar__series">
                        <ul>
                            <li><a href="">Sakamoto Days</a></li>
                            <li><a href="">My Dress Up Darling</a></li>
                        </ul>

                        <ul>
                            <li><a href="">Black Clover</a></li>
                            <li><a href="">My Hero Academia</a></li>
                        </ul>

                        <ul>
                            <li><a href="">Jujutsu Kaisen</a></li>
                            <li><a href="">Mashle: Magic And Muscles</a></li>
                        </ul>

                        <ul>
                            <li><a href="">One Punch Man</a></li>
                            <li><a href="">Spy X Family</a></li>
                        </ul>
                    </div>
                </li>

                <li class="navbar__link--category">
                    <a href="#" class="navbar__link">Category</a>
                    <div class="navbar__category">
                        <ul>
                            <li><a href="">Shounen</a></li>
                            <li><a href="">Slice Of Life</a></li>
                        </ul>

                        <ul>
                            <li><a href="">Rom-Com</a></li>
                            <li><a href="">Action</a></li>
                        </ul>

                        <ul>
                            <li><a href="">Family</a></li>
                            <li><a href="">Comedy</a></li>
                        </ul>

                        <ul>
                            <li><a href="">Fantasy</a></li>
                            <li><a href="">Drama</a></li>
                        </ul>
                    </div>
                </li>

                <li class="navbar__link--author">
                    <a href="#" class="navbar__link">Author</a>
                    <div class="navbar__author">
                        <ul>
                            <li><a href="">Murata Yusuke</a></li>
                            <li><a href="">Fukuda Shinichi</a></li>
                        </ul>

                        <ul>
                            <li><a href="">Komoto Hajime</a></li>
                            <li><a href="">Tabata Yūki</a></li>
                        </ul>

                        <ul>
                            <li><a href="">Horikoshi Kohei</a></li>
                            <li><a href="">Gege Akutami</a></li>
                        </ul>

                        <ul>
                            <li><a href="">Suzuki Yuto</a></li>
                            <li><a href="">Gege Akutami</a></li>
                        </ul>
                    </div>
                </li>
                <li class="navbar__link--price">
                    <a href="#" class="navbar__link">Price</a>
                    <div class="navbar__price">
                        <ul>
                            <li><a href="">Under $5 Dollars</a></li>
                        </ul>

                        <ul>
                            <li><a href="">$5 To $7 Dollars</a></li>
                        </ul>

                        <ul>
                            <li><a href="">$7 To $15 Dollars</a></li>
                        </ul>

                        <ul>
                            <li><a href="">Over $15 Dollars</a></li>
                        </ul>
                    </div>
                </li>
                <li class="navbar__link--about"><a href="#special-footer" class="navbar__link">About Us</a></li>
            </ul>

            <!-- nav bar icons -->
            <div class="navbar__home" style="display: flex">
                <a id="search__icon"><i class="fa-solid fa-magnifying-glass"></i></a>
                <div style="display: flex">
                    <a href="#" id="login__icon">
                        <i class="fa-regular fa-user"></i>
                    </a>
                    <div></div>
                </div>
                <a id="shopping__icon"><i class="fa-solid fa-cart-shopping"></i></a>
            </div>

            <div class="navbar__bar">
                <a id="navbar__bar__icon"><i class="fa-solid fa-bars"></i></a>
                <div style="display: flex">
                    <a href="#" id="login__icon__responsive">
                        <i class="fa-regular fa-user"></i>
                    </a>
                    <div></div>
                </div>
            </div>

            <div class="navbar__responsive__popup">
                <div class="navbar__responsive__close">
                    <a id="navbar__responsive__close__button"><i class="fa-solid fa-xmark"></i></a>
                </div>
                <div class="navbar__responsive">
                    <ul class="navbar__responsive__links">
                        <li class="navbar__responsive--home">
                            <a href="index.html" class="navbar__responsive__link">Home</a>
                        </li>
                        <li class="navbar__responsive--series">
                            <a class="navbar__responsive__link">Series</a>
                            <button id="navbar__responsive--series__button">
                                <i class="fa-solid fa-angle-right" id="right__angle"></i>
                                <i class="fa-solid fa-arrow-right" id="right__arrow"></i>
                            </button>
                        </li>
                        <li class="navbar__responsive--category">
                            <a class="navbar__responsive__link">Category</a>
                            <button id="navbar__responsive--category__button">
                                <i class="fa-solid fa-angle-right" id="right__angle"></i>
                                <i class="fa-solid fa-arrow-right" id="right__arrow"></i>
                            </button>
                        </li>
                        <li class="navbar__responsive--author">
                            <a class="navbar__responsive__link">Author</a>
                            <button id="navbar__responsive--author__button">
                                <i class="fa-solid fa-angle-right" id="right__angle"></i>
                                <i class="fa-solid fa-arrow-right" id="right__arrow"></i>
                            </button>
                        </li>
                        <li class="navbar__responsive--price">
                            <a class="navbar__responsive__link">Price</a>
                            <button id="navbar__responsive--price__button">
                                <i class="fa-solid fa-angle-right" id="right__angle"></i>
                                <i class="fa-solid fa-arrow-right" id="right__arrow"></i>
                            </button>
                        </li>
                        <li class="navbar__responsive--about">
                            <a href="#special-footer" class="navbar__responsive__link">About Us</a>
                        </li>
                    </ul>
                </div>
            </div>

        </nav>

        <!-- searchbox -->
        <div class="search__popup">
            <div class="search">
                <div class="searchbox">
                    <input type="search" placeholder="Search for...">
                    <a id="search__close"><i class="fa-solid fa-xmark" style="color:white;"></i></a>
                </div>
            </div>
        </div>

        <!-- shopping cart -->
        <div class="shopping__popup">
            <div class="shopping__container">
                <a id="shopping__close"><i class="fa-solid fa-xmark" style="color:white;"></i></a>
                <div class="shopping">
                    <div class="shopping__icon">
                        <i class="fa-solid fa-cart-shopping" style="color:white;"></i>
                    </div>
                    <br>
                    <h2>Your cart is empty</h2>
                    <button class="shopping__btn">Continue shopping</button>
                </div>
            </div>
        </div>
    </header>

    <main style="margin-bottom: 120px;">
        <section id="main__page">
            <!-- slider -->
            <div class="slider">
                <div class="slider__list">
                    <div class="slider__item">
                        <img src="../img/banner/1.png" alt="Sakamoto Days Cover">
                    </div>

                    <div class="slider__item">
                        <img src="../img/banner/2.png" alt="My Dress Up Darling Cover">
                    </div>

                    <div class="slider__item">
                        <img src="../img/banner/3.jpeg" alt="Classroom Of The Elite Cover">
                    </div>

                    <div class="slider__item">
                        <img src="../img/banner/4.jpeg" alt="Spy X Family Cover">
                    </div>

                    <div class="slider__item">
                        <img src="../img/banner/5.jpg" alt="Black Clover Cover">
                    </div>
                </div>

                <div class="slider__button">
                    <button id="slider__prev">
                        << /button>
                            <button id="slider__next">></button>
                </div>

                <ul class="slider__dots">
                    <li class="active"></li>
                    <li></li>
                    <li></li>
                    <li></li>
                    <li></li>
                </ul>
            </div>

            <div class="product__list">
                <h1>Products</h1>
                <div class="product__container">
                </div>
            </div>

            <div class="product__page">
                <div class="product">
                    <a id="product__close"><i class="fa-solid fa-xmark" style="color:white;"></i></a>
                    <div class="product__img">
                        <img id="product__img1" src="../img/books/sakamoto days/sakamoto-days-volume-6-primary.jpg">
                        <img id="product__img2" src="../img/books/sakamoto days/sakamoto-days-volume-6-back.jpg">

                        <a id="product__view1"><img
                                src="../img/books/sakamoto days/sakamoto-days-volume-6-primary.jpg"></a>

                        <a id="product__view2"><img
                                src="../img/books/sakamoto days/sakamoto-days-volume-6-back.jpg"></a>

                    </div>

                    <div class="product__info">
                        <h1>Sakamoto Days - Volume 06</h1>
                        <div class="product__info--rating">
                            <i class="fa-solid fa-star"></i>
                            <i class="fa-solid fa-star"></i>
                            <i class="fa-solid fa-star"></i>
                            <i class="fa-solid fa-star"></i>
                            <i class="fa-solid fa-star"></i>
                        </div>
                        <p>Author: </p>
                        <h2>Yuto Suzuki</h2>
                        <p>$9.99</p>
                        <p>Quantity:</p>

                        <button id="product__quantitydown">-</button><input type="text" id="product__quantity"
                            value="1"><button id="product__quantityup">+</button><br>
                        <button id="product__add">Add to cart</button>

                        <p>Availability: In stock</p><br>
                        <h4>Description</h4>
                        <p>Sakamoto Days manga volume 6 features story and art by Yuto Suzuki.</p><br>
                        <p>Dangerous serial killers clash with the Order and Sakamoto’s crew! As the battles rage on,
                            Sakamoto undergoes an unexpected transformation. Meanwhile, the evil mastermind X reveals
                            his true intent, which sends shock waves through the assassin world!</p>
                    </div>
                </div>
            </div>
        </section>

        <div class="cart__container">
            <h1>Cart</h1>
            <div class="cart-content">
                <!-- Cart Items List -->
                <table class="cart-table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            <th>Quantity</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody class="cart-items">
                    </tbody>
                </table>
                <!-- Cart Summary -->
                <div class="cart-summary">
                    <h3>Total of order: $0.00</h3>
                    <button class="checkout-button">Checkout</button>
                </div>
            </div>
        </div>

        <div class="billing-info">
            <h2>Billing Information</h2>
            <div id="billingForm">
                <label for="fullName">Full Name</label>
                <input type="text" id="fullName" required>

                <label for="address" z>Shipping Address</label>
                <input id="address" required></input>

                <!-- <label for="paymentMethod">Payment Method</label>
                <div style="overflow: hidden;">
                    <select id="paymentMethod" required>
                        <option value="creditCard">Credit Card</option>
                        <option value="paypal">PayPal</option>
                        <option value="bankTransfer">Bank Transfer</option>
                    </select>
                </div> -->
                <div style="text-align: center;">
                    <button class="pay-now-button" type="button" onclick="Order.handlePayNow()">Pay Now</button>
                </div>
            </div>
        </div>

        <div class="order__history">
            <h2>Your Order History</h2>

            <!-- Example Order -->
            <div class="order" style="max-height: 310px; overflow: auto;">
                <!-- <div style="display: flex;">
                    <div>
                        <div class="order__id">Order ID: #12345</div>
                        <div class="order__date">Date: 2023-11-01</div>
                        <div class="order__status status--cancel">Status: Pending</div>
                        <span class="show__details" onclick="toggleDetails(this)">View Details</span>
                    </div>
                    <div style="margin-left: 100px;">
                        <div class="order__items__details">
                            <strong>Items:</strong>
                            <ul>
                                <li>Comic: "Adventure Tales" - $10.00</li>
                                <li>Comic: "Mystery World" - $8.00</li>
                                <li>Comic: "Adventure Tales" - $10.00</li>
                                <li>Comic: "Mystery World" - $8.00</li>
                                <li>Comic: "Adventure Tales" - $10.00</li>
                                <li>Comic: "Mystery World" - $8.00</li>
                            </ul>
                        </div>
                    </div>
                </div> -->
            </div>
        </div>

        <section id="login__page">
            <div id="login">
                <h1>Login</h1>

                <div class="login__input">
                    <input type="text" id="login__input--username" placeholder="Username" required value="">
                </div>

                <div class="login__input">
                    <input type="password" id="login__input--password" placeholder="Password" required value="">
                    <label for="login__input--password"></label>
                </div>

                <div id="login__forget">
                    <a>Forget your password?</a>
                </div>

                <button type="submit" id="login__btn">Login</button>

                <div id="login__signup">
                    <a href="#" id="login__signup--nav">Sign Up</a>
                </div>
            </div>
        </section>

        <section id="signup__page">
            <div id="signup">
                <h1>Sign Up</h1>
                <!--   Username   -->
                <div class="signup__input">
                    <input type="text" id="signup__input--username" placeholder="Username" required value="">
                    <label for="signup__input--username"></label>
                </div>
                <!--   Password   -->
                <div class="signup__input">
                    <input type="password" id="signup__input--password" placeholder="Password" required>
                    <label for="signup__input--password"></label>
                </div>
                <!--   Confirm Password   -->
                <div class="signup__input">
                    <input type="password" id="signup__input--confpasword" placeholder="Confirm Password" required>
                    <label for="signup__input--confpasword"></label>
                </div>
                <!--   Email   -->
                <div class="signup__input">
                    <input type="email" id="signup__input--email" placeholder="Email" required>
                    <label for="signup__input--email"></label>
                </div>
                <!--   Phone number   -->
                <div class="signup__input">
                    <input type="tel" id="signup__input--phone" placeholder="076 302 0810" required>
                    <label for="signup__input--phone"></label>
                </div>

                <button type="submit" id="signup__btn">Create account</button>

                <div id="signup__login">
                    <a href="#" id="signup__login--nav">Already has account?</a>
                </div>
            </div>
        </section>
        <div id="notification"></div>
    </main>


    <special-footer id="special-footer"></special-footer>

    <!-- js -->
    <script src="../js/validation.js"></script>
    <script src="../js/user.js"></script>
    <script src="../js/header_footer.js"></script>
    <script src="../js/product.js"></script>
    <script>
        function toggleDetails(e) {
            const details = e.parentElement.nextElementSibling.children[0];
            if (details.style.display === "none") {
                details.style.display = "block";
                e.textContent = "Hide Details";
            } else {
                details.style.display = "none";
                e.textContent = "View Details";
            }
        }

        Product.onloadViewIndex();
        const URLOfIndex = window.location.href
        const URLtoAdmin = URLOfIndex.split("index.html")
        if (localStorage.getItem('admin') === 'admin') {
            window.location.href = `${URLtoAdmin[0]}admin.html`
        }

        let cartTable = JSON.parse(localStorage.getItem('cart')) || []
        let orderTable = JSON.parse(localStorage.getItem('order')) || []

        const productContainer = document.querySelector(".product__container")
        const cartItemContainer = document.querySelector(".cart-items")
        const orderContainer = document.querySelector(".order");
        const cartSummary = document.querySelector(".cart-summary")

        function renderViewIndex(renderProduct) {
            productContainer.innerHTML = ""
            renderProduct.forEach(p => {
                productContainer.innerHTML += `
                    <div id="${p.productId}" class="product__item">
                        <a>
                            <img src="${p.cover1}" alt="">
                        </a>
                        <h4>${p.series}</h4>
                        <p>$${p.price}</p>
                        <button id=${p.productId} onclick="Cart.addToCart(this)">+ Add to cart</button>
                        <p>Stock: ${p.stock}</p>
                    </div>
                `
            });
        }
        renderViewIndex(JSON.parse(localStorage.getItem('productTable')))

        class Cart {
            static addToCart(e) {
                console.log(e.id)
                const cartItem = JSON.parse(localStorage.getItem('productTable')).find(item => item.productId === `${e.id}`)
                const quantityInput = document.querySelector(`input[data-product-id="${e.id}"]`);
                const quantity = quantityInput ? (quantityInput.value) : 1;

                if (cartItem.stock === 0) {
                    alert("Hết hàng");
                    return;
                }

                if (!cartItem) {
                    alert("Sản phẩm này không tồn tại");
                    return;
                }

                const alreadyInCart = cartTable.find(item => item.productId === `${e.id}`);
                if (alreadyInCart) {
                    alert("Sản phẩm đã có trong giỏ hàng");
                    return;
                } else {
                    cartTable.push({ ...cartItem, quantity })
                }

                localStorage.setItem('cart', JSON.stringify(cartTable))
                renderCartPreview(cartTable)
            }
        }

        function renderCartPreview(cartItem) {
            cartItemContainer.innerHTML = ""
            cartItem.forEach(p => {
                cartItemContainer.innerHTML += `
                    <tr class="cart-item">
                        <td>
                            <img src="${p.cover1}"
                                alt="Product Image">
                            <div class="product-info">
                                <p class="product-title">${p.series}</p>
                                <p class="product-price">$${p.price}</p>
                            </div>
                        </td>
                        <td>
                            <input
                            class="cart__quantity" 
                            type="number" 
                            value="${p.quantity}" 
                            min="1"
                            max="${p.stock}"
                            data-product-id="${p.productId}"
                            >
                            <button id="${p.productId}"class="remove-button" onclick="removeFromCart(this)">Remove</button>
                        </td>
                        <td>
                            <p>$${p.price * p.quantity}</p>
                        </td>
                    </tr>
                `

                cartSummary.innerHTML = ""
                cartSummary.innerHTML = `
                    <h3>Total of order: ${cartTable.reduce((total, item) => total + item.price * item.quantity, 0).toFixed(2)}</h3>
                    <button class="checkout-button">Checkout</button>
                `
            });

            const quantityInputs = document.querySelectorAll(".cart__quantity");
            quantityInputs.forEach(input => {
                input.addEventListener("change", (e) => {
                    const newQuantity = parseInt(e.target.value);
                    const productId = e.target.getAttribute("data-product-id");
                    const itemInCart = cartTable.find(item => item.productId === productId);

                    if (itemInCart) {
                        itemInCart.quantity = newQuantity;
                        localStorage.setItem("cart", JSON.stringify(cartTable));
                        renderCartPreview(cartTable);
                    }
                });
            });
        }

        function removeFromCart(e) {
            console.log(e.id)
            const deleteItemInCart = cartTable.filter(item => item.productId !== e.id)
            cartTable = deleteItemInCart
            localStorage.setItem('cart', JSON.stringify(cartTable))
            renderCartPreview(cartTable)
            renderCartSummary()
        }

        function renderCartSummary() {
            cartSummary.innerHTML = ""
            cartSummary.innerHTML = `
                    <h3> Total of order: ${cartTable.reduce((total, item) => total + item.price * item.quantity, 0).toFixed(2)}</h3>
                    <button class="checkout-button">Checkout</button>
            `
        }

        class Order {
            constructor(orderId, userId, orderDate, orderStatus, orderItems, orderPrice, userFullname, orderAddrress) {
                this.orderId = orderId
                this.userId = userId
                this.orderDate = orderDate
                this.orderStatus = orderStatus
                this.orderItems = orderItems
                this.orderPrice = orderPrice
                this.userFullname = userFullname
                this.orderAddrress = orderAddrress
            }

            static insert(orderId, userId, orderDate, orderStatus, orderItems, orderPrice, userFullname, orderAddrress) {
                const newOrder = new Order(
                    orderId, // `order_${ Order.generateId(orderTable) } `
                    userId,
                    orderDate, // new Date()
                    orderStatus,
                    orderItems,
                    orderPrice,
                    userFullname,
                    orderAddrress
                )
                Order.updateStockForOrder(newOrder, 'decrease');
                orderTable.push(newOrder);
            }

            static generateId = (data) => {
                if (data.length === 0) {
                    return 0;
                } else {
                    const index = data[data.length - 1].orderId.split("_")[1];
                    return parseInt(index) + 1;
                }
            };
            //
            static handlePayNow() {
                console.log("Handling pay now...")

                Order.addToOrder('Pending');

                renderCartSummary();
            }
            //
            static addToOrder(status = "Pending") {
                console.log("Adding to order...")
                console.log(orderTable)
                Order.insert(
                    `order_${Order.generateId(orderTable)} `,
                    `user_1`,
                    new Date().toISOString().split('T')[0],
                    status,
                    cartTable.map(item => ({
                        productId: item.productId,
                        series: item.series,
                        category: item.category,
                        author: item.author,
                        quantity: item.quantity,
                        totalPrice: item.price * item.quantity
                    })),
                    cartTable.reduce((total, item) => total + item.price * item.quantity, 0),
                    "Tu Anh Phu",
                    "Quan 8"
                );
                localStorage.setItem("order", JSON.stringify(orderTable))

                alert("Your order has been successfully placed!");

                cartTable = [];
                localStorage.setItem("cart", JSON.stringify(cartTable));

                renderCartPreview(cartTable);
                Order.renderOrderView(orderTable);
            }

            static updateStockForOrder(order, action) {
                console.log("Updating stock for order...")
                console.log("Order:", order);
                order.orderItems.forEach(item => {
                    const product = productTable.find(p => p.productId === item.productId);
                    if (product) {
                        if (action === "decrease") {
                            product.stock -= item.quantity;
                        } else if (action === "increase") {
                            product.stock += item.quantity;
                        }
                    }
                });

                // Save the updated product data back to localStorage
                localStorage.setItem("productTable", JSON.stringify(productTable));

                renderViewIndex(JSON.parse(localStorage.getItem("productTable")))
            }

            static renderOrderView(renderOrder) {
                orderContainer.innerHTML = ""

                renderOrder.forEach(o => {
                    orderContainer.innerHTML += `
                        <div style = "display: flex;">
                            <div>
                                <div class="order__id">Order ID: ${o.orderId}</div>
                                <div class="order__date">Date: ${o.orderDate}</div>
                                <div class="order__status ${Order.getStatus(o.orderStatus)}">Status: ${o.orderStatus}</div>
                                <span class="show__details" onclick="toggleDetails(this)">View Details</span>
                            </div>
                            <div style="margin-left: 100px;">
                                <div class="order__items__details">
                                    <strong>Items:</strong>
                                    <ul>
                                        ${o.orderItems.map(item => `
                                            <li>Series: ${item.series}</li>
                                            <li>Quantity: ${item.quantity}</li>
                                            <li>Price: $${item.totalPrice}</li>
                                            <hr>
                                        `).join('')}
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <hr>
                    `
                })
            }

            static getStatus(status) {
                if (status === "Pending") {
                    return "status--pending"
                }
                if (status === "Completed") {
                    return "status--complte"
                }
                if (status === "Canceled") {
                    return "status--cancel"
                }
            }

            static onloadCartHistory(){
                
            }
        }

        (() => {
            Product.onloadViewIndex();
            renderCartPreview(cartTable)
            Order.renderOrderView(orderTable)
        })()
    </script>
</body>

</html>